#!/bin/sh

# Generated by Chef for <%= node['hostname'] %>.
# Local modifications will be overwritten.

source "/usr/local/etc/ec2_const.sh"
if [ ! -f "$EC2_DATAFILE" ]; then
    source "/usr/local/bin/ec2_get_data.sh"
fi

DOMAINNAME=
TAG_DOMAINNAME=`cat $EC2_DATAFILE | grep TAG | grep Domain | cut -f5`
if [ -n "$TAG_DOMAINNAME" ]; then
  DOMAINNAME=$TAG_DOMAINNAME
fi

HOSTS_LOCAL=
LOCAL_IPV4=`get_metadata "local-ipv4"`
LOCAL_HOSTNAME=`get_metadata "local-hostname" | cut -d"." -f1`
if [ -n "$LOCAL_IPV4" ]; then
  if [ -n "$DOMAINNAME" ]; then
    HOSTS_LOCAL="$LOCAL_IPV4 $LOCAL_HOSTNAME $LOCAL_HOSTNAME.$DOMAINNAME"
  else
    HOSTS_LOCAL="$LOCAL_IPV4 $LOCAL_HOSTNAME"
  fi
fi

HOSTS_TAG=
TAG_HOSTNAME=`cat $EC2_DATAFILE | grep TAG | grep Name | cut -f5`
if [ -n "$HOSTNAME" ]; then
  if [ -n "$DOMAINNAME" ]; then
    HOSTS_TAG="$LOCAL_IPV4 $TAG_HOSTNAME $TAG_HOSTNAME.$DOMAINNAME"
  else 
    HOSTS_TAG="$LOCAL_IPV4 $TAG_HOSTNAME"
  fi
fi


# Set hostname
if [ -n "$TAG_HOSTNAME" ]; then
  hostname "$TAG_HOSTNAME"
  echo $TAG_HOSTNAME > /etc/hostname
fi


# Add fqdn to hosts file
if [ -n "$TAG_HOSTNAME" ]; then
  cat<<EOF > /etc/hosts
# This file is automatically genreated by ec2-hostname script
127.0.0.1 localhost localhost.localdomain

$HOSTS_LOCAL
$HOSTS_TAG

# The following lines are desirable for IPv6 capable hosts
::1 ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts
EOF
fi


# Set hosted zone id
if [ -n "$DOMAINNAME" ]; then
  HOSTED_ZONE_ID=`get_route53_hosted_zone_id "$DOMAINNAME"`

  # A Record
  change_route53_record_set \
    $HOSTED_ZONE_ID "DELETE" "$LOCAL_HOSTNAME.$DOMAINNAME." "A" "$LOCAL_IPV4"
  change_route53_record_set \
    $HOSTED_ZONE_ID "CREATE" "$LOCAL_HOSTNAME.$DOMAINNAME." "A" "$LOCAL_IPV4"

  # CNAME Record
  change_route53_record_set \
    $HOSTED_ZONE_ID "DELETE" "$TAG_HOSTNAME.$DOMAINNAME." "CNAME" "$LOCAL_HOSTNAME.$DOMAINNAME"
  change_route53_record_set \
    $HOSTED_ZONE_ID "CREATE" "$TAG_HOSTNAME.$DOMAINNAME." "CNAME" "$LOCAL_HOSTNAME.$DOMAINNAME"
fi
